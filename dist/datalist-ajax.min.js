var p=class extends HTMLElement{constructor(){super(),this.cache={},this.url="",this.param={},this.inputdelay=300,this.querymin=1,this.optionmax=20,this.valid="",this.lastQuery=""}static get observedAttributes(){return["id","api","resultdata","resultname","inputdelay","querymin","optionmax","valid","storekeys"]}attributeChangedCallback(t,i,r){if(i!==r&&(this[t]=r,t==="api")){this.param={};for(let s of this.api.matchAll(/\$\{(.+?)\}/g)){let n=document.getElementById(s[1].trim());n&&(this.param[s[0]]=n)}}}connectedCallback(){if(this.input=this.firstElementChild,!this.input)return;let t=(this.input.name||this.input.id)+"_list",i=document.createElement("datalist");i.id=t,this.datalist=this.insertBefore(i,this.input),this.input.setAttribute("autocomplete","off"),this.input.setAttribute("list",t);let r;this.inputHandler=s=>{clearTimeout(r),r=setTimeout(()=>this.runQuery(s),this.inputdelay)},this.input.addEventListener("input",this.inputHandler),this.changeHandler=()=>{let s=this.isValid()||this.reset||{};this.input.setCustomValidity(""),this.input.checkValidity();let n={},e=this.input,d=this.id;function c(l,h=""){if(Array.isArray(l))l.forEach((a,u)=>c(a,`${h}[${u}]`));else if(typeof l=="object")for(let a in l)c(l[a],`${h+(h?".":"")}${a}`);else Array.from(e.form.querySelectorAll(`[data-autofill="${h}"], [data-autofill^="${d}.${h}"]`)).forEach(a=>{a.value=String(l)||"",n[h]=""})}c(s);let o=new CustomEvent("autofill",{detail:s});this.dispatchEvent(o),this.reset=n},this.input.addEventListener("change",this.changeHandler)}disconnectedCallback(){this.input.removeEventListener("input",this.inputHandler),this.input.removeEventListener("blur",this.changeHandler),this.input.removeAttribute("list"),this.datalist.remove()}runQuery(){let t=this.input.value.trim().toLowerCase(),i=this.isValid(),r=this.lastQuery,s=r&&this.cache[r],n=this.api||"";for(let e in this.param)n=n.replaceAll(e,(this.param[e].value||"").trim());if(!(!this.api||i||t.length<this.querymin||s&&s.complete&&s.url===n&&t.startsWith(r))){if(this.cache[t]&&this.cache[t].url===n){this.datalistUpdate(t);return}this.cache[t]={},fetch(n).then(e=>e.json()).then(e=>{if(!e)return;this.resultdata&&(e=this.getNestedKeys(e,this.resultdata)),e=Array.isArray(e)?e:[e];let d=document.createDocumentFragment(),c=this.optionmax;for(let o=0;o<e.length&&c;o++){let l=this.resultname?this.getNestedKeys(e[o],this.resultname):e[o],h=[];if(this.storekeys){let a=this.storekeys.split(",").map(u=>u.trim());for(let u of a){let m=this.getNestedKeys(e[o],u);m!==void 0&&(h[u]=m)}}if(l&&l.toLowerCase().includes(t)){let a=document.createElement("option");a.value=l;for(let u in h)a.setAttribute("data-"+u,h[u]);d.appendChild(a),c--}}this.cache[t]={url:n,data:e,frag:d,complete:c>0},this.datalistUpdate(t)})}}datalistUpdate(t){let i=this.cache[t];!i||!i.frag||(this.lastQuery=t,this.datalist.replaceChildren(i.frag.cloneNode(!0)))}isValid(){let t=this.input.value.trim();if(!(!t||!this.lastQuery))return this.cache[this.lastQuery].data.find(i=>t===this.getNestedKeys(i,this.resultname))}getNestedKeys(t,i){if(i in t)return t[i];let r=i.split("."),s=t;for(let n=0;n<r.length&&(s=s[r[n]],s!==void 0);n++);return s}};window.customElements.define("auto-complete",p);
